---
title: "Overview of the vista package"
author: "Eric J. Ward, Sean C. Anderson, Lewis A.K. Barnett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteDepends{sdmTMB,remotes}
  %\VignetteIndexEntry{Overview of the vista package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Here we will use the vista package visualize output from spatiotemporal models

```{r set-knitr-options, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
library("knitr")
opts_chunk$set(message = FALSE, fig.width = 5.5)
```

```{r}
library(vista)
```

### Example with sdmTMB

sdmTMB is a package for fitting generalized linear mixed models (GLMMs) with spatial and spatiotemporal Gaussian random fields. The package can be installed here,

```{r warning=FALSE, message=FALSE, results="hide"}
if (require(remotes)) {
    install.packages("remotes",repos = "http://cran.us.r-project.org")
}
#if(require(sdmTMB)) {
  remotes::install_github("pbs-assess/sdmTMB")
#}
install.packages("INLA",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
library(sdmTMB)
```

Now, we can load the example dataset from Pacific cod, collected by Fisheries and Oceans Canada.

```{r warning=FALSE, message=FALSE, results="hide"}
d <- pcod
```

We fit a fairly simple spatiotemporal model, using an example from the package. Don't worry about all the arguments -- the density of Pacific cod is modeled as a function of fixed effects (years) and spatiotemporal random fields (essentially different spatial maps in each year). The response is modeled with a Tweedie distribution.

```{r warning=FALSE, message=FALSE, results="hide"}
m <- sdmTMB(data = d,
formula = density ~ 0 + as.factor(year),
time = "year", spde = make_mesh(d, c("X", "Y"), n_knots = 80, type = "kmeans"),
family = tweedie(link = "log"), anisotropy = TRUE,
include_spatial = FALSE)
```

Next, we can calculate the residual and predicted values from the fitted model

```{r warning=FALSE, message=FALSE, results="hide"}
d$pred = predict(m)$est
d$resid = residuals(m)
```

Finally, we can use the `vista` package to generate diagnostic plots. Each plot can be run individually. Some example functions are below:

```{r eval=FALSE}
# Look at all predictions over space, faceted by time (or not)
pred_space()
# Look at all predictions time
pred_time()
# Look at residuals over space, faceted by time (or not)
resid_space()
# Look at all residuals over time
resid_time()
# Look at variation in residuals through time
sd_resid_time()
# Look at variation in residuals across space, faceted by time (or not)
sd_resid_space()
# Look at qq plots, faceted by time (or not) 
qq()
# Look at qq plots over space, faceted by time (or not)
qq_space()
# Look at predictions vs residuals, faceted by time (or not)
pred_resid()
# Look at time series of Moran statistics (e.g. residuals, predicted values)
moran_ts()
```

Alternatively, we can call the wrapper function to run all plots. This is a lot more convenient, and returns a list of ggplot() objects. 

```{r warning=FALSE, message=FALSE, results="hide"}
plots <- diagnostic_plots(d, time="year")
```

We can inspect the plots individually, e.g. 
```{r warning=FALSE, message=FALSE}
names(plots)
```

Or look at them individually. For example we can look at the residuals spatially, and across time slices with
```{r}
plots$resid_space_bytime
```

Or the time series of Moran statistics on the residuals from the model,
```{r}
plots$moran_resid
```

Some plots are specific to particular models. For example, looking at the mean residuals over space, all values are 0 because each row of the dataframe has a unique (X,Y) coordinate -- as opposed to repeat sampling at fixed stations.

The standard deviation of residuals over time seems to suggest a non-stationary trend in the variability,

```{r}
plots$sd_resid_time
```


### Example with a Generalized Additive Model (GAM)

Examples in the vista package are shown using a simulated dataset and `mgcv`. Virtually any other modeling framework can be used, as long as some predicted value
can be generated (generating a residual is optional). As an example of repeated sampling at the same stations, we'll generate a new dataset,

```{r}
set.seed(2021)
d <- expand.grid(X=runif(30), Y = runif(30), 
year = as.factor(1:5))
d$density = rnorm(0.01*d$X -0.001*d$X*d$X + d$Y*0.02 - 0.005*d$Y*d$Y,0,0.1)
```

We'll fit a simple model with a single bivariate smooth (spatial component)
```{r message=FALSE, warning=FALSE, results="hide"}
m <- mgcv::gam(density ~ 0 + as.factor(year) + s(X,Y),data=d)
```

Generating predictions and residuals from fitted objects is straightforward,
```{r message=FALSE, warning=FALSE, results="hide"}
d$pred = predict(m)
d$resid = residuals(m)
```

And as before, we can run the entire set of diagnostic plots
```{r}
# the default names match, with the exception of year -- so change it
plots <- diagnostic_plots(d, time="year")
```

To highlight some things beyond the sdmTMB example, we expect there to be significant autocorrelation in the predictions (using the Moran statistic), and that indeed appears to be the case

```{r}
plots$moran_pred
```

but it's generally not present in the residuals, suggesting that our spatial model is explaining away most of it.

```{r}
plots$moran_resid
```

